{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
  <div class="grid" style="margin-bottom: 2rem;">
    <div class="card">
      <h2>Stammdaten</h2>
      <p><strong>{{ customers|length }}</strong> Kunden</p>
      <p><strong>{{ machines|length }}</strong> Maschinen</p>
      <p><strong>{{ suppliers|length }}</strong> Lieferanten</p>
    </div>
    <div class="card">
      <h2>Aufträge</h2>
      <p><strong>{{ orders|length }}</strong> Produktionsaufträge</p>
      <p><strong>{{ purchase_orders|length }}</strong> offene Bestellungen</p>
      <form action="/schedule/backlog" method="post">
        <button type="submit">Backlog nach Priorität planen</button>
      </form>
      <p class="muted" style="margin-top: 0.5rem;">Erweiterte Parameter unter <a href="/planning">Feinplanung</a>.</p>
    </div>
    <div class="card">
      <h2>Bestand</h2>
      <p><strong>{{ inventory|length }}</strong> Materialien gepflegt</p>
      <p><strong>{{ low_stock|length }}</strong> Artikel unter Meldebestand</p>
    </div>
  </div>

  <div class="card" style="margin-bottom: 2rem;">
    <h2>Produktionsaufträge</h2>
    <table>
      <thead>
        <tr>
          <th>Auftrag</th>
          <th>Kunde</th>
          <th>Fällig</th>
          <th>Priorität</th>
          <th>Status</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
          {% set customer = customers | selectattr("id", "equalto", order.customer_id) | first %}
          <tr>
            <td>{{ order.reference }}</td>
            <td>{{ customer.name if customer else "Unbekannt" }}</td>
            <td>{{ order.due_date.strftime("%d.%m.%Y") }}</td>
            {% set priority_name = order.priority.name.lower() %}
            <td><span class="tag {{ 'critical' if priority_name == 'critical' else 'high' if priority_name == 'high' else '' }}">{{ order.priority.label }}</span></td>
            <td><span class="status-badge status-{{ order.status.name }}">{{ order.status.value }}</span></td>
            <td class="actions">
              <form action="/orders/{{ order.id }}/schedule" method="post">
                <input type="submit" value="Planen" />
              </form>
              <form action="/orders/{{ order.id }}/plan-purchase" method="post">
                <input type="submit" value="Einkauf" class="secondary" />
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="grid" style="margin-bottom: 2rem;">
    <div class="card">
      <h2>Nächste Operationen</h2>
      <ul class="list-inline" style="display: block; list-style: none; padding: 0;">
        {% for entry in upcoming %}
          {% set order_obj = orders | selectattr("id", "equalto", entry.order_id) | first %}
          {% set operation_plan = order_obj.operations | selectattr("operation.id", "equalto", entry.operation_id) | first if order_obj else None %}
          {% set machine_obj = machines | selectattr("id", "equalto", entry.machine_id) | first %}
          <li style="display: block; margin-bottom: 0.6rem;">
            <strong>{{ entry.start.strftime("%d.%m %H:%M") }}</strong>
            – {{ entry.order_priority.label }} –
            {{ operation_plan.operation.name if operation_plan else entry.operation_id }}
            auf {{ machine_obj.name if machine_obj else entry.machine_id }}
          </li>
        {% else %}
          <li>Keine geplanten Operationen.</li>
        {% endfor %}
      </ul>
    </div>
    <div class="card">
      <h2>Materialengpässe</h2>
      <ul class="list-inline" style="display: block; list-style: none; padding: 0;">
        {% for shortage in shortages %}
          <li style="display: block; margin-bottom: 0.6rem;">
            <strong>{{ shortage.name }}</strong><br />
            Bedarf: {{ "%.1f"|format(shortage.required_quantity) }} – Prognose: {{ "%.1f"|format(shortage.projected_on_hand) }}<br />
            Empfehlung: {{ "%.1f"|format(shortage.reorder_recommendation) }}
            {% if shortage.recommended_supplier_name %}
              <span class="muted">Lieferant: {{ shortage.recommended_supplier_name }}</span>
            {% endif %}
          </li>
        {% else %}
          <li>Aktuell keine kritischen Bedarfe.</li>
        {% endfor %}
      </ul>
      <p class="muted" style="margin-top: 0.5rem;">Detailplanung im Bereich <a href="/procurement">Einkauf</a>.</p>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Bestände</h2>
      <table>
        <thead>
          <tr>
            <th>Artikel</th>
            <th>Bestand</th>
            <th>Sicherheitsbestand</th>
            <th>Meldebestand</th>
          </tr>
        </thead>
        <tbody>
          {% for item in inventory %}
            <tr>
              <td>{{ item.name }}</td>
              <td>{{ "%.1f"|format(item.quantity_on_hand) }} {{ item.unit_of_measure }}</td>
              <td>{{ "%.1f"|format(item.safety_stock) }}</td>
              <td>{{ "%.1f"|format(item.reorder_point) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="card">
      <h2>Offene Bestellungen</h2>
      <table>
        <thead>
          <tr>
            <th>Lieferant</th>
            <th>Artikel</th>
            <th>Menge</th>
            <th>Liefertermin</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for po in purchase_orders %}
            {% set item = inventory | selectattr("id", "equalto", po.item_id) | first %}
            <tr>
              <td>{{ po.supplier_name or po.supplier_id }}</td>
              <td>{{ item.name if item else po.item_id }}</td>
              <td>{{ "%.1f"|format(po.quantity) }}</td>
              <td>{{ po.expected_receipt.strftime("%d.%m.%Y") }}</td>
              <td>{{ po.status }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="5" class="muted">Noch keine Bestellungen angelegt.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

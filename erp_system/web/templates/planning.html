{% extends "base.html" %}

{% block title %}Feinplanung{% endblock %}

{% block content %}
  {% if scheduled_count or operations_planned or overloaded_count or purchase_created %}
    <div class="alert success">
      <strong>Planung aktualisiert.</strong>
      {% if scheduled_count %} {{ scheduled_count }} Auftrag{% if scheduled_count != 1 %}e{% endif %} verarbeitet.{% endif %}
      {% if operations_planned %} Insgesamt {{ operations_planned }} Operationen eingeplant.{% endif %}
      {% if overloaded_count %} {{ overloaded_count }} Maschine{% if overloaded_count != 1 %}n{% endif %} über dem Wochenbudget.{% endif %}
      {% if purchase_created %} {{ purchase_created }} Beschaffungsvorschlag{% if purchase_created != 1 %}e{% endif %} erstellt.{% endif %}
    </div>
  {% elif options_updated %}
    <div class="alert">
      Planungseinstellungen wurden gespeichert.
    </div>
  {% endif %}

  <div class="grid" style="margin-bottom: 2rem;">
    <div class="card">
      <h2>Planungsparameter</h2>
      <form method="post" action="/planning/options">
        <div class="form-grid">
          <div>
            <label for="priority_weight">Gewichtung Priorität</label>
            <input id="priority_weight" name="priority_weight" type="number" min="0.1" step="0.1" value="{{ '%.2f'|format(planning_options.priority_weight) }}" required />
          </div>
          <div>
            <label for="due_date_weight">Gewichtung Fälligkeit</label>
            <input id="due_date_weight" name="due_date_weight" type="number" min="0" step="0.1" value="{{ '%.2f'|format(planning_options.due_date_weight) }}" required />
          </div>
          <div>
            <label for="horizon_days">Planungshorizont (Tage)</label>
            <input id="horizon_days" name="horizon_days" type="number" min="0" value="{{ planning_options.horizon_days }}" />
          </div>
          <div>
            <label for="max_orders_per_cycle">Max. Aufträge pro Lauf</label>
            <input id="max_orders_per_cycle" name="max_orders_per_cycle" type="number" min="0" value="{{ planning_options.max_orders_per_cycle }}" />
          </div>
          <div>
            <label for="setup_time_factor">Rüstzeit-Faktor</label>
            <input id="setup_time_factor" name="setup_time_factor" type="number" min="0" step="0.05" value="{{ '%.2f'|format(planning_options.setup_time_factor) }}" />
          </div>
          <div>
            <label for="gap_between_operations_minutes">Puffer zwischen Operationen (min)</label>
            <input id="gap_between_operations_minutes" name="gap_between_operations_minutes" type="number" min="0" value="{{ planning_options.gap_between_operations_minutes }}" />
          </div>
          <div>
            <label for="default_start_time">Standard-Schichtbeginn</label>
            <input id="default_start_time" name="default_start_time" type="time" value="{{ planning_options.default_start_time.strftime('%H:%M') }}" />
          </div>
        </div>
        <label class="checkbox-inline" style="margin-top: 0.75rem;">
          <input type="checkbox" name="auto_release_orders" {% if planning_options.auto_release_orders %}checked{% endif %} />
          <span>Aufträge nach erfolgreicher Planung automatisch freigeben</span>
        </label>
        <div style="margin-top: 1rem;">
          <button type="submit">Einstellungen speichern</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>Backlog planen</h2>
      <form method="post" action="/planning/run">
        <div class="form-grid">
          <div>
            <label for="run_start_date">Startdatum</label>
            <input id="run_start_date" name="start_date" type="date" />
          </div>
          <div>
            <label for="run_start_time">Startzeit</label>
            <input id="run_start_time" name="start_time_value" type="time" placeholder="{{ planning_options.default_start_time.strftime('%H:%M') }}" />
          </div>
          <div>
            <label for="run_horizon">Horizont (Tage)</label>
            <input id="run_horizon" name="horizon_override" type="number" min="0" placeholder="{{ planning_options.horizon_days }}" />
          </div>
          <div>
            <label for="run_limit">Auftragslimit</label>
            <input id="run_limit" name="max_orders" type="number" min="0" placeholder="{{ planning_options.max_orders_per_cycle }}" />
          </div>
        </div>
        <label class="checkbox-inline" style="margin-top: 0.75rem;">
          <input type="checkbox" name="plan_purchases" />
          <span>Materialbedarf nach Planung bewerten</span>
        </label>
        <label class="checkbox-inline" style="margin-top: 0.35rem;">
          <input type="checkbox" name="auto_create_purchases" />
          <span>Beschaffungen sofort anlegen (benötigt Materialbewertung, Standard: {{ 'aktiv' if procurement_options.auto_create_orders else 'deaktiviert' }})</span>
        </label>
        <p class="muted" style="margin-top: 0.5rem;">
          Detailparameter zur Beschaffung finden Sie im Bereich <a href="/procurement">Einkauf</a>.
        </p>
        <div style="margin-top: 1rem;">
          <button type="submit">Planung ausführen</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card" style="margin-bottom: 2rem;">
    <h2>Auftragsübersicht</h2>
    <table>
      <thead>
        <tr>
          <th>Auftrag</th>
          <th>Kunde</th>
          <th>Fälligkeit</th>
          <th>Priorität</th>
          <th>Status</th>
          <th>Operationen</th>
          <th>Geplantes Ende</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
          {% set customer = customers | selectattr('id', 'equalto', order.customer_id) | first %}
          {% set scheduled_ops = order.operations | selectattr('scheduled_end') | list %}
          {% set last_plan = scheduled_ops | max(attribute='scheduled_end') if scheduled_ops else None %}
          <tr>
            <td><strong>{{ order.reference }}</strong></td>
            <td>{{ customer.name if customer else 'Unbekannt' }}</td>
            <td>{{ order.due_date.strftime('%d.%m.%Y') }}</td>
            <td>{{ order.priority.label }}</td>
            <td>{{ order.status.value }}</td>
            <td>{{ order.operations|length }}</td>
            <td>
              {% if last_plan %}
                {{ last_plan.scheduled_end.strftime('%d.%m.%Y %H:%M') }}
              {% else %}
                <span class="muted">nicht geplant</span>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="7" class="muted">Noch keine auftragsrelevanten Daten vorhanden.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Nächste Operationen</h2>
      <ul class="list-inline" style="display: block; list-style: none; padding: 0;">
        {% for entry in upcoming %}
          {% set order_obj = all_orders | selectattr('id', 'equalto', entry.order_id) | first %}
          {% set operation_plan = order_obj.operations | selectattr('operation.id', 'equalto', entry.operation_id) | first if order_obj else None %}
          {% set machine_obj = machines | selectattr('id', 'equalto', entry.machine_id) | first %}
          <li style="display: block; margin-bottom: 0.6rem;">
            <strong>{{ entry.start.strftime('%d.%m %H:%M') }}</strong>
            – {{ entry.order_priority.label }} –
            {{ operation_plan.operation.name if operation_plan else entry.operation_id }}
            auf {{ machine_obj.name if machine_obj else entry.machine_id }}
            <span class="muted">bis {{ entry.end.strftime('%d.%m %H:%M') }}</span>
          </li>
        {% else %}
          <li>Keine geplanten Operationen vorhanden.</li>
        {% endfor %}
      </ul>
    </div>

    <div class="card">
      <h2>Maschinenkapazitäten</h2>
      <table>
        <thead>
          <tr>
            <th>Maschine</th>
            <th>Kapazität</th>
            <th>Kalender</th>
          </tr>
        </thead>
        <tbody>
          {% for machine in machines %}
            {% set calendar = calendars | selectattr('id', 'equalto', machine.shift_calendar_id) | first %}
            <tr>
              <td>{{ machine.name }}</td>
              <td>{{ '%.1f'|format(machine.capacity_hours_per_week) }} h/Woche</td>
              <td>{{ calendar.name if calendar else 'kein Kalender' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

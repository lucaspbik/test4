{% extends "base.html" %}

{% block title %}Schichtkalender{% endblock %}

{% block content %}
  <div class="card" style="margin-bottom: 2rem;">
    <h2>Schichtkalender</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Schichten</th>
          <th>Ausnahmen</th>
        </tr>
      </thead>
      <tbody>
        {% for calendar in calendars %}
          <tr>
            <td><strong>{{ calendar.name }}</strong> <span class="muted">({{ calendar.id[:8] }})</span></td>
            <td>
              {% for shift in calendar.shifts %}
                <div>
                  <span class="tag">{{ shift.name }}</span>
                  {{ shift.start_time.strftime("%H:%M") }} – {{ shift.end_time.strftime("%H:%M") }}<br />
                  <span class="muted">Wochentage: {{ shift.weekdays | join(", ") }}</span>
                </div>
              {% else %}
                <span class="muted">Keine Schichten definiert.</span>
              {% endfor %}
            </td>
            <td>
              {% for day in calendar.non_working_days|list|sort %}
                <span class="tag">{{ day.strftime("%d.%m.%Y") }}</span>
              {% else %}
                <span class="muted">keine Einträge</span>
              {% endfor %}
              <form method="post" action="/calendars/{{ calendar.id }}/non-working-day" style="margin-top: 0.5rem;">
                <input type="date" name="day" required />
                <button type="submit" class="secondary">Feiertag hinzufügen</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="3" class="muted">Noch keine Schichtkalender angelegt.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Neuen Kalender erstellen</h2>
      <form method="post" action="/calendars">
        <label for="cal_name">Bezeichnung</label>
        <input id="cal_name" name="name" required />
        <label for="shift_definitions">Schichten (eine pro Zeile, Format: Name|Start|Ende|Wochentage)</label>
        <textarea id="shift_definitions" name="shift_definitions" placeholder="Frühschicht|06:00|14:00|0,1,2,3,4&#10;Spätschicht|14:00|22:00|0,1,2,3,4" required></textarea>
        <label for="non_working_days">Feiertage (YYYY-MM-DD, Komma getrennt)</label>
        <input id="non_working_days" name="non_working_days" />
        <div style="margin-top: 1rem;">
          <button type="submit">Kalender speichern</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>Kalender zu Maschine zuordnen</h2>
      <form method="post" action="/machines/{{ (machines|first).id if machines else '' }}/calendar">
        <label for="machine_select">Maschine</label>
        <select id="machine_select" name="machine_id" onchange="this.form.action='/machines/'+this.value+'/calendar'">
          {% for machine in machines %}
            <option value="{{ machine.id }}">{{ machine.name }} ({{ machine.shift_calendar_id or 'kein Kalender' }})</option>
          {% endfor %}
        </select>
        <label for="calendar_id">Kalender</label>
        <select id="calendar_id" name="calendar_id">
          {% for calendar in calendars %}
            <option value="{{ calendar.id }}">{{ calendar.name }}</option>
          {% endfor %}
        </select>
        <div style="margin-top: 1rem;">
          <button type="submit">Zuordnen</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
